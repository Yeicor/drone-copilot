#: kivy 2.1.0
#: import Settings kivy.uix.settings
#: import MyVideo ui.video.video
#: import MyJoystick ui.util.joystick
#: import ShadowLabel ui.util.shadow
#: import ShadowButton ui.util.shadow
#: import ShadowImage ui.util.shadow
#: import Clock kivy.clock.Clock

# ============ TEMPLATES ============

# ============ MAIN UI ============
FloatLayout:

    # === BACKGROUND LIVE VIDEO STREAM ===
    MyVideo:
        id: video

    # === MAIN CENTER CONTROLS ===
    GridLayout:
        cols: 3
        size_hint: (1, .4 * float(app.config.get('ui', 'scaling')))
        pos_hint: {'x': 0, 'y': 0}
        opacity: 0.5 * float(app.config.get('ui', 'opacity'))
        RelativeLayout:
            size_hint: (None, None)
            size: (.4 * root.height * float(app.config.get('ui', 'scaling')), .4 * root.height * float(app.config.get('ui', 'scaling')))
            MyJoystick:
                id: joystick_left
                on_pad: Clock.schedule_once(lambda _: app.action_joysticks(self.pad_x, self.pad_y, None, None), 0)
            Image:
                id: keyboard_w
                source: 'assets/keyboard/W_Key_Dark.png'
                pos_hint: {'x': 0.5 - 0.2/2, 'y': 1.0 - 0.2}
                size_hint: (0.2, 0.2)
                allow_stretch: True
            Image:
                id: keyboard_s
                source: 'assets/keyboard/S_Key_Dark.png'
                pos_hint: {'x': 0.5 - 0.2/2, 'y': 0.0}
                size_hint: (0.2, 0.2)
                allow_stretch: True
            Image:
                id: keyboard_a
                source: 'assets/keyboard/A_Key_Dark.png'
                pos_hint: {'x': 0.0, 'y': 0.5 - 0.2/2}
                size_hint: (0.2, 0.2)
                allow_stretch: True
            Image:
                id: keyboard_d
                source: 'assets/keyboard/D_Key_Dark.png'
                pos_hint: {'x': 1.0 - 0.2, 'y': 0.5 - 0.2/2}
                size_hint: (0.2, 0.2)
                allow_stretch: True
        StackLayout: # Stack all controls in the middle automatically!
            orientation: 'lr-bt'
            spacing: 2, 2
            ShadowButton:
                id: takeoff_land_button
                text: 'Takeoff'
                on_press: app.action_takeoff_land()
                color: 1, 1, 0, 1  # Yellow warning color
                size_hint: 1, 0.25
                Image:
                    source: 'assets/keyboard/Space_Key_Dark.png'
                    pos: self.parent.pos[0] - self.parent.size[0] / 3, self.parent.pos[1]
                    size: self.parent.size
                    allow_stretch: True
                Image:
                    source: 'assets/controller/XboxSeriesX_Y.png'
                    pos: self.parent.pos[0] + self.parent.size[0] * (1/(4/(1.5/2)) + 1/3), self.parent.pos[1] + self.parent.size[1] / (4/(1.5/2))
                    size: self.parent.size[0] / 1.5, self.parent.size[1] / 1.5
                    allow_stretch: True
            ShadowButton:
                id: tracking_button
                text: 'Tracking (OFF)'
                on_press: app.action_toggle_tracking()
                size_hint: 0.75, 0.25
            Button:
                id: tracking_settings_button
                on_press: app.action_toggle_settings()
                size_hint: 0.25, 0.25
                ShadowImage:
                    source: 'assets/other/settings.png'
                    pos: [self.parent.pos[i] + self.parent.size[i] / 4 for i in range(len(self.parent.size))]
                    size: [i / 2 for i in self.parent.size]
                    allow_stretch: True
            # ShadowButton:
            #     text: 'TO DO'
            #     size_hint: 0.33, 0.25
            # ShadowButton:
            #     text: 'TO DO'
            #     size_hint: 0.34, 0.25
            # ShadowButton:
            #     text: 'TO DO'
            #     size_hint: 0.33, 0.25
        RelativeLayout:
            size_hint: (None, None)
            size: (.4 * root.height * float(app.config.get('ui', 'scaling')), .4 * root.height * float(app.config.get('ui', 'scaling')))
            MyJoystick:
                id: joystick_right
                on_pad: Clock.schedule_once(lambda _: app.action_joysticks(None, None, self.pad_x, self.pad_y), 0)
            Image:
                id: keyboard_up
                source: 'assets/keyboard/Arrow_Up_Key_Dark.png'
                pos_hint: {'x': 0.5 - 0.2/2, 'y': 1.0 - 0.2}
                size_hint: (0.2, 0.2)
                allow_stretch: True
            Image:
                id: keyboard_down
                source: 'assets/keyboard/Arrow_Down_Key_Dark.png'
                pos_hint: {'x': 0.5 - 0.2/2, 'y': 0.0}
                size_hint: (0.2, 0.2)
                allow_stretch: True
            Image:
                id: keyboard_left
                source: 'assets/keyboard/Arrow_Left_Key_Dark.png'
                pos_hint: {'x': 0.0, 'y': 0.5 - 0.2/2}
                size_hint: (0.2, 0.2)
                allow_stretch: True
            Image:
                id: keyboard_right
                source: 'assets/keyboard/Arrow_Right_Key_Dark.png'
                pos_hint: {'x': 1.0 - 0.2, 'y': 0.5 - 0.2/2}
                size_hint: (0.2, 0.2)
                allow_stretch: True


    # === TOP-LEFT STATUS ===
    BoxLayout:
        id: top_left_panel
        orientation: 'vertical'
        size_hint: (.05 * float(app.config.get('ui', 'scaling')), .3 * float(app.config.get('ui', 'scaling')))
        pos_hint: {'x': 0, 'y': 1 - self.size_hint[1]}
        opacity: 0.5 * float(app.config.get('ui', 'opacity'))
        RelativeLayout:
            ShadowImage:
                source: 'assets/dronestatus/battery.png'
                allow_stretch: True
            ShadowLabel:
                id: battery_label
                text: '??%'  # TODO: Tooltips for most UI elements!
                # TODO: Red for low!
                font_size: self.parent.height * 0.5
        BoxLayout:
            ShadowImage:
                source: 'assets/dronestatus/thermometer.png'
                size_hint: (0.5, 1)
                allow_stretch: True
            ShadowLabel:
                id: temperature_label
                text: '??ÂºC'
                # TODO: Red for high!
                font_size: self.parent.height * 0.5
        BoxLayout:
            ShadowImage:
                source: 'assets/dronestatus/signal.png'
                size_hint: (0.5, 1)
                allow_stretch: True
            ShadowLabel:
                id: signal_label
                text: '??%'
                # TODO: Red for low!
                font_size: self.parent.height * 0.5
        BoxLayout:
            ShadowImage:
                source: 'assets/dronestatus/height.png'
                size_hint: (0.5, 1)
                allow_stretch: True
            ShadowLabel:
                id: height_label
                text: '??m'
                # TODO: Red for high!
                font_size: self.parent.height * 0.5
        BoxLayout: # Just a spacer to move the buttons to the top
            size_hint: (None, 3)

    # === TOP SETTINGS ===
    BoxLayout:
        id: top_panel
        size_hint: (0.5 * float(app.config.get('ui', 'scaling')), .05 * float(app.config.get('ui', 'scaling')))
        pos_hint: {'x': 0.5 - self.size_hint[0] / 2, 'y': 1 - self.size_hint[1]}

    # === TOP-RIGHT SETTINGS ===
    BoxLayout:
        id: top_right_panel
        orientation: 'vertical'
        size_hint: (.04 * float(app.config.get('ui', 'scaling')), .3 * float(app.config.get('ui', 'scaling')))
        pos_hint: {'x': 1 - self.size_hint[0], 'y': 1 - self.size_hint[1]}
        opacity: 0.25 * float(app.config.get('ui', 'opacity'))
        Button:
            on_press: app.action_toggle_settings()
            ShadowImage:
                source: 'assets/other/settings.png'
                pos: self.parent.pos
                size: self.parent.size
                allow_stretch: True
            Image:
                id: keyboard_o
                source: 'assets/keyboard/O_Key_Dark.png'
                pos: (self.parent.pos[0] - self.size[0]*0.25, self.parent.pos[1] - self.size[1]*0.25)
                size: self.parent.size[0]/2, self.parent.size[1]/2
                allow_stretch: True
        ShadowButton:
            on_press: app.action_take_photo()
            ShadowImage:
                source: 'assets/other/camera.png'
                pos: self.parent.pos
                size: self.parent.size
                allow_stretch: True
            Image:
                id: keyboard_p
                source: 'assets/keyboard/P_Key_Dark.png'
                pos: (self.parent.pos[0] - self.size[0]*0.25, self.parent.pos[1] - self.size[1]*0.25)
                size: self.parent.size[0]/2, self.parent.size[1]/2
                allow_stretch: True
            Image:
                id: gamepad_b
                source: 'assets/controller/XboxSeriesX_B.png'
                pos: (self.parent.pos[0] + self.size[0]*0.4, self.parent.pos[1] - self.size[1]*0.25)
                size: self.parent.size[0]/2, self.parent.size[1]/2
                allow_stretch: True
        BoxLayout: # Just a spacer to move the buttons to the top
            size_hint: (None, 3)
